<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="NtQueueApcThreadEx - NtDoc, the native NT API online documentation">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NtQueueApcThreadEx - NtDoc</title>
    <link rel="shortcut icon" href="favicon.ico">
    <script src="dark-mode-toggle-preload.js"></script>
    <script>
        document.write(getStylesheetTagsForDarkModeToggle(
            'modules/water-2.1.1-light.css',
            'modules/water-2.1.1-dark.css',
        ));
    </script>
    <noscript>
        <link rel="stylesheet" href="modules/water-2.1.1-light.css" media="(prefers-color-scheme: light)">
        <link rel="stylesheet" href="modules/water-2.1.1-dark.css" media="(prefers-color-scheme: dark)">
    </noscript>
    <link rel="stylesheet" href="modules/virtual-select/virtual-select.css">
    <link rel="stylesheet" href="modules/pygments-css.css">
    <link rel="stylesheet" href="ntdoc.css">
    <noscript>
        <link rel="stylesheet" href="ntdoc-noscript.css">
    </noscript>
</head>
<body>
    <header>
        <a href="."><img class="ntdoc-title-logo" src="logo.png" alt="logo"></a>
        <h1 class="ntdoc-title">
            NtQueueApcThreadEx - NtDoc
        </h1>
        <div class="ntdoc-subtitle">
            Native API online documentation, based on the System Informer
            (formerly Process Hacker) <a target="_blank"
            href="https://github.com/winsiderss/systeminformer/tree/master/phnt">phnt
            headers</a>
        </div>
        <div id="ntdoc-search-select"></div>
    </header>
    <div class="ntdoc-code-elements">
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><div class="ntdoc-code-header">#ifndef _NTPSAPI_H
// Threads
#if (PHNT_MODE != PHNT_MODE_KERNEL)
#if (PHNT_VERSION &gt;= PHNT_WIN7)

</div><div class="ntdoc-code-intro"></div><div class="ntdoc-code-body">NTSYSCALLAPI
<a href="ntstatus">NTSTATUS</a>
NTAPI
NtQueueApcThreadEx(
    _In_ HANDLE ThreadHandle,
    _In_opt_ HANDLE ReserveHandle, // <a href="ntallocatereserveobject">NtAllocateReserveObject</a> // SPECIAL_USER_APC
    _In_ <a href="pps_apc_routine">PPS_APC_ROUTINE</a> ApcRoutine,
    _In_opt_ PVOID ApcArgument1,
    _In_opt_ PVOID ApcArgument2,
    _In_opt_ PVOID ApcArgument3
    );
</div><div class="ntdoc-code-footer">
#endif
#endif
#endif
</div></code></pre><div class="ntdoc-code-links"><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/f133e1e169bdaf53262fc98a3aab4636dda8d900/phnt/include/ntpsapi.h#L1749">View code on GitHub</a></div></div>
<div class="ntdoc-code-element">
<pre class="ntdoc-code-pre"><code class="ntdoc-code"><div class="ntdoc-code-header">#ifndef _NTZWAPI_H

</div><div class="ntdoc-code-intro"></div><div class="ntdoc-code-body">NTSYSCALLAPI
<a href="ntstatus">NTSTATUS</a>
NTAPI
ZwQueueApcThreadEx(
    _In_ HANDLE ThreadHandle,
    _In_opt_ HANDLE ReserveHandle, // <a href="ntallocatereserveobject">NtAllocateReserveObject</a> // SPECIAL_USER_APC
    _In_ <a href="pps_apc_routine">PPS_APC_ROUTINE</a> ApcRoutine,
    _In_opt_ PVOID ApcArgument1,
    _In_opt_ PVOID ApcArgument2,
    _In_opt_ PVOID ApcArgument3
    );
</div><div class="ntdoc-code-footer">
#endif
</div></code></pre><div class="ntdoc-code-links"><a target="_blank" href="https://github.com/winsiderss/systeminformer/blob/f133e1e169bdaf53262fc98a3aab4636dda8d900/phnt/include/ntzwapi.h#L3400">View code on GitHub</a></div></div>
</div>
<div class="ntdoc-description">
<p>Queues a user-mode Asynchronous Procedure Call (APC) on the specified thread.</p>

<h1 id="parameters">Parameters</h1>

<ul>
<li><code>ThreadHandle</code> - a handle the the thread granting the <code>THREAD_SET_CONTEXT</code> access.</li>
<li><code>ReserveHandle</code> - an optional handle to the reserve object (see <code><a href="ntallocatereserveobject">NtAllocateReserveObject</a></code>) or a <code><a href="queue_user_apc_special_user_apc">QUEUE_USER_APC_SPECIAL_USER_APC</a></code> constant.</li>
<li><code>ApcRoutine</code> - the address of the function to invoke.</li>
<li><code>ApcArgument1</code> - the first argument to pass to the APC routine.</li>
<li><code>ApcArgument2</code> - the second argument to pass to the APC routine.</li>
<li><code>ApcArgument3</code> - the third argument to pass to the APC routine.</li>
</ul>

<h1 id="remarks">Remarks</h1>

<p>This function has three modes of operation:</p>

<ol>
<li>When <code>ReserveHandle</code> is <code>NULL</code>, the function behaves identically to <code><a href="ntqueueapcthread">NtQueueApcThread</a></code>. To execute the APC, the thread must first enter an alertable wait via <code><a href="ntdelayexecution">NtDelayExecution</a></code> (or a similar function) or call <code><a href="nttestalert">NtTestAlert</a></code>.</li>
<li>When <code>ReserveHandle</code> is a handle to the reserve object, the function uses this object to avoid additional memory allocations. Otherwise, the behavior is identical to option 1.</li>
<li>When <code>ReserveHandle</code> is the <code><a href="queue_user_apc_special_user_apc">QUEUE_USER_APC_SPECIAL_USER_APC</a></code> value, the function queues a <em>special user-mode APC</em> that does not require the thread to enter an alertable state. The APC will be executed on the next thread's transition to user mode. This flag is supported on Windows 10 RS5 (1809) and above. Because execution of special APCs is not synchronized with the target thread (which might happen to acquire locks), it is crucial to keep the amount and complexity of the code invoked by the special APC routine to a minimum.</li>
</ol>

<p>To queue a WoW64 APC, encode the <code>ApcRoutine</code> parameter using the <code><a href="wow64encodeapcroutine">Wow64EncodeApcRoutine</a></code> macro or use <code><a href="rtlqueueapcwow64thread">RtlQueueApcWow64Thread</a></code>.</p>

<p>Note that user APCs on the Native API level have three parameters in contrast with the <a href="https://learn.microsoft.com/en-us/windows/win32/api/winnt/nc-winnt-papcfunc">Win32 APCs</a> that only have one.</p>

<h1 id="related-win32-api">Related Win32 API</h1>

<ul>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc2"><code>QueueUserAPC2</code></a></li>
</ul>

<h1 id="see-also">See also</h1>

<ul>
<li><code><a href="ntqueueapcthread">NtQueueApcThread</a></code></li>
<li><code><a href="ntqueueapcthreadex2">NtQueueApcThreadEx2</a></code></li>
<li><code><a href="rtlqueueapcwow64thread">RtlQueueApcWow64Thread</a></code></li>
<li><code><a href="ntopenthread">NtOpenThread</a></code></li>
<li><code><a href="nttestalert">NtTestAlert</a></code></li>
</ul>
</div>
<div class="ntdoc-description-links">
<a target="_blank" href="https://github.com/m417z/ntdoc/blob/main/descriptions/ntqueueapcthreadex.md">Edit description on GitHub</a>
</div>

    <!-- For sticky footer: https://stackoverflow.com/a/34146411 -->
    <div class="spacer"></div>
    <footer>
        By <a href="https://m417z.com/" target="_blank" rel="noopener">m417z</a> &bull;
        <a href="https://github.com/m417z/ntdoc" target="_blank" rel="noopener">GitHub repository</a> &bull;
        <dark-mode-toggle permanent></dark-mode-toggle>
    </footer>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YWF4NP61SX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YWF4NP61SX');
    </script>
    <script src="modules/jquery-3.7.0.min.js"></script>
    <script src="modules/q-1.5.1.js"></script>
    <script src="modules/virtual-select/virtual-select-jquery.min.js"></script>
    <script type="module" src="modules/dark-mode-toggle-0.14.6.min.mjs"></script>
    <script src="ntdoc.js"></script>
</body>
</html>
